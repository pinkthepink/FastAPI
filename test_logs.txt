============================= test session starts ==============================
platform linux -- Python 3.12.7, pytest-8.3.5, pluggy-1.5.0
rootdir: /home/pedro-michel-nikolaides/Documents/Github/FastAPI
configfile: pytest.ini
plugins: asyncio-0.26.0, anyio-4.9.0
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 14 items

tests/api/test_clientes.py ..F.F..                                       [ 50%]
tests/repositories/test_cliente_repository.py .......                    [100%]

=================================== FAILURES ===================================
______________________________ test_create_client ______________________________

async_client = <httpx.AsyncClient object at 0x7145b98b9d90>

    @pytest.mark.asyncio
    async def test_create_client(async_client: AsyncClient):
        """Test creating a client."""
        new_client_data = {
            "name": "API Test Client",
            "document_id": "999.888.777-66",
            "active": True,
            "contact": {
                "phone": "555-999-8888",
                "email": "api_test@example.com",
            },
            "address": {
                "street": "202 API St",
                "city": "API City",
                "state": "AP",
                "zip_code": "12345",
                "country": "API Country",
            },
            "notes": "API test client notes",
        }
    
>       response = await async_client.post(
            f"{settings.api_v1_str}/clients/", json=new_client_data
        )

tests/api/test_clientes.py:76: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
app/api/endpoints/clientes.py:85: in create_client
    created_client = await repository.create(client)
app/repositories/cliente_repository.py:127: in create
    existing = await self.collection.find_one({"document_id": client_data["document_id"]})
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/motor/metaprogramming.py:75: in method
    return framework.run_on_executor(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/motor/frameworks/asyncio/__init__.py:85: in run_on_executor
    return loop.run_in_executor(_EXECUTOR, functools.partial(fn, *args, **kwargs))
../../../anaconda3/lib/python3.12/asyncio/base_events.py:850: in run_in_executor
    self._check_closed()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=True debug=False>

    def _check_closed(self):
        if self._closed:
>           raise RuntimeError('Event loop is closed')
E           RuntimeError: Event loop is closed

../../../anaconda3/lib/python3.12/asyncio/base_events.py:541: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    app.utils.error_handlers:error_handlers.py:140 Unhandled exception: Event loop is closed
Traceback (most recent call last):
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/FastAPI/app/api/endpoints/clientes.py", line 85, in create_client
    created_client = await repository.create(client)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/FastAPI/app/repositories/cliente_repository.py", line 127, in create
    existing = await self.collection.find_one({"document_id": client_data["document_id"]})
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/motor/metaprogramming.py", line 75, in method
    return framework.run_on_executor(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/motor/frameworks/asyncio/__init__.py", line 85, in run_on_executor
    return loop.run_in_executor(_EXECUTOR, functools.partial(fn, *args, **kwargs))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/anaconda3/lib/python3.12/asyncio/base_events.py", line 850, in run_in_executor
    self._check_closed()
  File "/home/pedro-michel-nikolaides/anaconda3/lib/python3.12/asyncio/base_events.py", line 541, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______________________________ test_update_client ______________________________

async_client = <httpx.AsyncClient object at 0x7145b87dfbf0>
sample_clients = [{'_id': ObjectId('6825581a145451a871ef8e11'), 'active': True, 'address': {'city': 'Test City', 'country': 'Test Count...tate': 'AC', 'street': '789 Pine Rd', ...}, 'contact': {'email': 'another@example.com', 'phone': '555-333-4444'}, ...}]

    @pytest.mark.asyncio
    async def test_update_client(async_client: AsyncClient, sample_clients):
        """Test updating a client."""
        client_id = str(sample_clients[0]["_id"])
    
        update_data = {
            "name": "API Updated Client",
            "notes": "Updated via API test",
        }
    
        response = await async_client.put(
            f"{settings.api_v1_str}/clients/{client_id}", json=update_data
        )
        assert response.status_code == status.HTTP_200_OK
    
        data = response.json()
        assert data["name"] == "API Updated Client"
        assert data["notes"] == "Updated via API test"
        assert data["document_id"] == sample_clients[0]["document_id"]
    
        # Test with invalid ID
        response = await async_client.put(
            f"{settings.api_v1_str}/clients/invalid_id", json=update_data
        )
        assert response.status_code == status.HTTP_404_NOT_FOUND
    
        # Test with empty update data
>       response = await async_client.put(
            f"{settings.api_v1_str}/clients/{client_id}", json={}
        )

tests/api/test_clientes.py:142: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
../petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
app/api/endpoints/clientes.py:171: in update_client
    updated_client = await repository.update(client_id, client_update)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.repositories.cliente_repository.ClientRepository object at 0x7145b87efe90>
id = ObjectId('6825581a145451a871ef8e11'), update_data = {}

    async def update(
        self, id: Union[str, ObjectId], update_data: Union[ClientUpdate, Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        Update a client.
    
        Args:
            id: Client ID
            update_data: Data to update
    
        Returns:
            Updated client dictionary
    
        Raises:
            NotFoundError: If client not found
            DatabaseError: If database operation fails
        """
        if isinstance(id, str):
            try:
                id = ObjectId(id)
            except Exception as e:
                logger.error(f"Invalid ObjectId format: {id}, error: {e}")
                raise NotFoundError(f"Invalid client ID format: {id}")
    
        if isinstance(update_data, ClientUpdate):
            # Filter out None values
            update_data = {k: v for k, v in update_data.model_dump().items() if v is not None}
    
        if not update_data:
>           raise ValueError("No update data provided")
E           ValueError: No update data provided

app/repositories/cliente_repository.py:182: ValueError
------------------------------ Captured log call -------------------------------
ERROR    app.repositories.cliente_repository:cliente_repository.py:174 Invalid ObjectId format: invalid_id, error: 'invalid_id' is not a valid ObjectId, it must be a 12-byte input or a 24-character hex string
ERROR    app.utils.error_handlers:error_handlers.py:49 Application error: Invalid client ID format: invalid_id
ERROR    app.utils.error_handlers:error_handlers.py:140 Unhandled exception: No update data provided
Traceback (most recent call last):
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/petshop-gestao-v2/python/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/FastAPI/app/api/endpoints/clientes.py", line 171, in update_client
    updated_client = await repository.update(client_id, client_update)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/pedro-michel-nikolaides/Documents/Github/FastAPI/app/repositories/cliente_repository.py", line 182, in update
    raise ValueError("No update data provided")
ValueError: No update data provided
=========================== short test summary info ============================
FAILED tests/api/test_clientes.py::test_create_client - RuntimeError: Event l...
FAILED tests/api/test_clientes.py::test_update_client - ValueError: No update...
========================= 2 failed, 12 passed in 0.80s =========================
